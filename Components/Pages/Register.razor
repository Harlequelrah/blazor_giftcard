@page "/register"
@using blazor_giftcard.Services
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@using System.ComponentModel.DataAnnotations;
@using System.ComponentModel.DataAnnotations.Schema;
@using System.Text.Json.Serialization;
@inject NavigationManager Navigation

@if (errorMessages.Count > 0)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var error in errorMessages)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<EditForm Model="user" OnValidSubmit="HandleRegistration" FormName="registerForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Email:</label>
        <InputText @bind-Value="user.Email" />
    </div>
    <div>
        <label>Password:</label>
        <InputText @bind-Value="user.Password" type="password" />
    </div>
      <div>
        <label>Adresse:</label>
        <InputText @bind-Value="user.Adresse" />
    </div>
      <div>
        <label>SubscriberName:</label>
        <InputText @bind-Value="user.SubscriberName" />
    </div>
      <div>
        <label>Telephone:</label>
        <InputText @bind-Value="user.Telephone" />
    </div>
    <button type="submit">Register</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private User user { get; set; } = new User();
    private List<string> errorMessages = new List<string>();

    private async Task HandleRegistration()
    {
        errorMessages.Clear(); // Clear previous error messages

        var response = await Http.PostAsJsonAsync("http://localhost:5107/api/User/register/subscriber", user);
        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            if (errorResponse != null && errorResponse.Errors != null)
            {
                foreach (var error in errorResponse.Errors)
                {
                    foreach (var errorMessage in error.Value)
                    {
                        errorMessages.Add(errorMessage); // Add error messages to the list
                    }
                }
            }
            else
            {
                errorMessages.Add("An unknown error occurred.");
            }
        }
    }

    public class User
    {
        [EmailAddress]
        [Required]
        public string Email { get; set; }
        [Required]
        public string Password { get; set; }
        [Required]
        public string Adresse { get; set; }
        [Required]
        public string SubscriberName { get; set; }
        [Required]
        public string Telephone { get; set; }
    }

    public class ErrorResponse
    {
        public Dictionary<string, string[]> Errors { get; set; }
        public string Type { get; set; }
        public string Title { get; set; }
        public int Status { get; set; }
        public string TraceId { get; set; }
    }
}
